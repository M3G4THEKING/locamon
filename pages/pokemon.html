<table id="mon_table" class="table table-striped table-bordered" style="width:100%">
    <tbody> </tbody>
</table>
<script>
    var monTable;
    $(document).ready(function() {
        monTable = $('#mon_table').DataTable({
            order: [
                [2, "asc"]
            ],
            paging: true,
            lengthChange: true,
            searching: true,
            processing: true,
            ajax: {
                url: './functions/api.php?type=pokemon',
                dataSrc: 'data'
            },
            ordering: true,
            lengthChange: true,
            rowId: 'id',
            columns: [{
                "title": "Pokemon",
                "type": "string",
                "data": null,
                "createdCell": function(td, cellData, rowData, row, col) {
                    let gradient;
                    if (rowData.types.length === 1) {
                        gradient = '60deg, ' + rowData.types[0].color + ', transparent 50%';
                    } else if (rowData.types.length === 2) {
                        gradient = '60deg, ' + rowData.types[0].color + ', ' + rowData
                            .types[1].color + ' 30%, transparent 60%';
                    }
                    $(td).css('background', 'linear-gradient(' + gradient + ')');
                },
                "render": {
                    display: function(data, type, row) {
                        if (row.form !== '0' && row.form !== 'Normal') {
                            row.name = row.form + ' ' + row.name;
                        }
                        return `<img class="img-fluid" src="${row.sprite}" /><strong>${row.name}</strong></td>`;
                    },
                    sort: "name",
                    _: "name",
                    filter: "name"
                },
                "className": "all"
            }, {
                "title": "Link",
                "data": null,
                "render": {
                    display: function(data, type, row) {
                        return `<a href="${mapLink}?lat=${row.lat}&?lon=${row.lon}">Maps</a>`;
                    }
                },
                "searchable": false,
                "orderable": false,
                "classname": "all"
            }, {
                "title": "Disappears",
                "data": null,
                "type": "date",
                "render": {
                    display: function(data, type, row) {
                        return `<div><strong>${row.disappear_time}</strong></div><div class="countdown" data-timestamp="${row.expires}"></div>`;
                    },
                    sort: "expires",
                    _: "disappear_time",
                    filter: "expires"
                },
                "classname": "all"
            }, {
                "title": "Updated",
                "data": null,
                "type": "date",
                "render": {
                    display: "last_modified",
                    sort: "updated",
                    _: "last_modified",
                    filter: "updated"
                }
            }, {
                "title": "Encountered",
                "type": "num",
                "data": null,
                "render": {
                    display: function(data, type, row) {
                        if (row.iv !== '' && row.iv !== null) {
                            return `${row.iv}%  <i class="far fa-check-square fa-2x showIv text-success"></i>`;
                        } else {
                            return '<i class="far fa-times-circle fa-2x"></i>';
                        }
                    },
                    filter: function(data, type, row) {
                        if (row.iv !== '' && row.iv !== null) {
                            return row.iv;
                        } else {
                            return '0';
                        }
                    },
                    sort: function(data, type, row) {
                        if (row.iv === '' || row.iv === null) {
                            return 0;
                        } else {
                            return row.iv;
                        }
                    }
                },
                "searchable": false
            }]
        });
        monTable.on('draw', countdown('mon'));

        $('#mon_table').on('click', '.showIv', function() {
            var tr = $(this).closest('tr');
            var row = monTable.row(tr);

            if (row.child.isShown()) {
                // This row is already open - close it
                row.child.hide();
                tr.removeClass('shown');
            } else {
                // Open this row (the format() function would return the data to be shown)
                if (row.child() && row.child().length) {
                    row.child.show();
                } else {
                    row.child(monChild(row.data())).show();
                }
                tr.addClass('shown');
            }
        });

        function ivColors(iv) {
            iv = parseInt(iv);
            if (iv <= 6) {
                return '#ff0000';
            } else if (iv > 6 && iv <= 11) {
                return '#fada5e'
            } else if (iv > 11) {
                return '#00ff00';
            }
        }

        function monChild(data) {
            let formLine;
            if (data.static_map !== '') {
                let image = data.static_map;
            }
            let atk_color = ivColors(data.atk_iv);
            let sta_color = ivColors(data.sta_iv);
            let def_color = ivColors(data.def_iv);
            if (data.form !== '0' && data.form !== "Normal") {
                formLine = `<li><strong>Form - </strong>${data.form}</li>`
            } else {
                formLine = '';
            }
            const row = `
            <div class="card">
                <div class="card-body">
                    <h5 class="text-left"><span style="text-decoration: underline;">Stats</span></h5>
                    <hr />
                    <div class="row">
                        <div class="col">
                            <div class="row">
                                <div class="col-3 d-flex justify-content-center">
                                    <div class="table-responsive">
                                        <table class="table">
                                            <tbody>
                                                <tr>
                                                    <td><strong>IV - ${data.iv}</strong></td>
                                                    <td class="d-flex bg-secondary text-light">
                                                        <i class="fas fa-fist-raised fa-lg"></i><span style="color:${atk_color}"> ${data.atk_iv} </span>
                                                        <i class="fa fa-shield-alt fa-lg"></i><span style="color:${def_color}"> ${data.def_iv} </span>
                                                        <i class="fas fa-plus-circle fa-lg">-</i><span style="color:${sta_color}"> ${data.sta_iv} </span>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Level - ${data.level}</strong><br /></td>
                                                    <td><strong>CP - ${data.cp}</strong></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="col-4 d-flex flex-column justify-content-around">
                                    <ul class="list-unstyled">
                                        <li><strong>Quick Move </strong>- ${data.move_1}</li>
                                        <li><strong>Charge Move </strong>- ${data.move_2}</li>
                                        <li><strong>Gender - </strong>${data.gender}</li>
                                        ${formLine}
                                    </ul>
                                </div>
                                <div class="col-4">
                                    <div class="row d-flex justify-content-center">
                                        <img src="${data.static_map}" alt="static map" height="150"/>
                                    </div>
                                    <div class="row">
                                        <div class="col d-flex justify-content-between">
                                            <a href="http://maps.apple.com/?sll=${data.lat},${data.lon}">
                                                <img class="img-fluid" width="40" height="40" src="./images/AppleMaps_logo.svg" />
                                            </a>
                                            <a href="$google_dir = "https://www.google.com/maps/dir/?api=1&destination=${data.lat},${data.lon}">
                                                <img class="img-fluid" src="./images/GoogleMaps_logo.svg" width="40" height="40" />
                                            </a>
                                            <a href="https://www.waze.com/ul?ll=${data.lat}%2C${data.lon}&navigate=yes">
                                                <img class="img-fluid" src="./images/Waze_logo.svg" width="40" height="40" />
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
            return row;
        }
    });
</script>